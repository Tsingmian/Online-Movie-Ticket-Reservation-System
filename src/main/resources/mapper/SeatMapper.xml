<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.movie_ticket_reservation.mapper.SeatMapper">

    <!-- 根据座位ID查询 -->
    <select id="selectById" parameterType="long" resultType="com.example.movie_ticket_reservation.entity.Seat">
        SELECT id,
        screening_id AS screeningId,
        row_num AS rowNum,
        col_num AS colNum,
        status,
        lock_time AS lockTime
        FROM seats
        WHERE id = #{id}
    </select>

    <!-- 查询某场次所有座位 -->
    <select id="selectByScreeningId" parameterType="long" resultType="com.example.movie_ticket_reservation.entity.Seat">
        SELECT id,
        screening_id AS screeningId,
        row_num AS rowNum,
        col_num AS colNum,
        status,
        lock_time AS lockTime
        FROM seats
        WHERE screening_id = #{screeningId}
        ORDER BY row_num, col_num
    </select>

    <!-- 锁定单个座位 -->
    <update id="lockSeat" parameterType="long">
        UPDATE seats
        SET status = 1, lock_time = NOW()
        WHERE id = #{id} AND status = 0
    </update>

    <!-- 批量锁定座位 -->
    <update id="lockSeats" parameterType="java.util.List">
        UPDATE seats
        SET status = 1, lock_time = NOW()
        WHERE id IN
        <foreach collection="seatIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 0
    </update>

    <!-- 单个支付 -->
    <update id="sellSeat" parameterType="long">
        UPDATE seats SET status = 2 WHERE id = #{id} AND status = 1
    </update>

    <!-- 批量支付 -->
    <update id="sellSeats" parameterType="java.util.List">
        UPDATE seats
        SET status = 2
        WHERE id IN
        <foreach collection="seatIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 1
    </update>

    <!-- 释放单个锁 -->
    <update id="releaseSeat" parameterType="long">
        UPDATE seats SET status = 0, lock_time = NULL WHERE id = #{id} AND status = 1
    </update>

    <!-- 批量释放锁 -->
    <update id="releaseSeats" parameterType="java.util.List">
        UPDATE seats
        SET status = 0, lock_time = NULL
        WHERE id IN
        <foreach collection="seatIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 1
    </update>

</mapper>
